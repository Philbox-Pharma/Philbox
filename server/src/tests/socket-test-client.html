<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Socket.IO Task Management Test</title>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f5f5f5;
    }
    .container {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    h1, h2 {
      color: #333;
    }
    .status {
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
    }
    .status.connected {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .status.disconnected {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .controls {
      margin: 20px 0;
    }
    input, button {
      padding: 8px 12px;
      margin: 5px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    button {
      background-color: #007bff;
      color: white;
      cursor: pointer;
      border: none;
    }
    button:hover {
      background-color: #0056b3;
    }
    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    .events {
      max-height: 400px;
      overflow-y: auto;
      background-color: #f8f9fa;
      padding: 15px;
      border-radius: 4px;
      border: 1px solid #dee2e6;
    }
    .event {
      background-color: white;
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      border-left: 4px solid #007bff;
    }
    .event.task-created {
      border-left-color: #28a745;
    }
    .event.task-updated {
      border-left-color: #ffc107;
    }
    .event.task-deleted {
      border-left-color: #dc3545;
    }
    .event.task-comment {
      border-left-color: #17a2b8;
    }
    .event-time {
      font-size: 12px;
      color: #6c757d;
    }
    .event-type {
      font-weight: bold;
      color: #007bff;
    }
    .event-data {
      margin-top: 8px;
      font-family: monospace;
      font-size: 13px;
      background-color: #f8f9fa;
      padding: 8px;
      border-radius: 4px;
      overflow-x: auto;
    }
    .clear-btn {
      background-color: #6c757d;
    }
    .clear-btn:hover {
      background-color: #5a6268;
    }
  </style>
</head>
<body>
  <h1>ðŸ”Œ Socket.IO Task Management Test Client</h1>

  <div class="container">
    <h2>Connection Status</h2>
    <div id="status" class="status disconnected">Disconnected</div>
  </div>

  <div class="container">
    <h2>Connection Controls</h2>
    <div class="controls">
      <label>User Type:</label>
      <select id="userType">
        <option value="salesperson">Salesperson</option>
        <option value="admin">Admin</option>
      </select>

      <label>User ID:</label>
      <input type="text" id="userId" placeholder="Enter user ID" />

      <button id="connectBtn" onclick="connect()">Connect</button>
      <button id="disconnectBtn" onclick="disconnect()" disabled>Disconnect</button>
    </div>

    <div class="controls">
      <label>Room to Join:</label>
      <input type="text" id="roomName" placeholder="e.g., salesperson:123 or branch:456" />
      <button id="joinRoomBtn" onclick="joinRoom()" disabled>Join Room</button>
    </div>
  </div>

  <div class="container">
    <h2>Received Events <button class="clear-btn" onclick="clearEvents()">Clear</button></h2>
    <div id="events" class="events">
      <p style="color: #6c757d;">No events received yet. Connect and join a room to start receiving events.</p>
    </div>
  </div>

  <div class="container">
    <h2>Event Listeners Active</h2>
    <ul id="listeners">
      <li>âœ… task:created</li>
      <li>âœ… task:updated</li>
      <li>âœ… task:comment_added</li>
      <li>âœ… task:deleted</li>
      <li>âœ… task:status_updated</li>
    </ul>
  </div>

  <script>
    let socket = null;
    let eventCount = 0;

    function updateStatus(connected, message) {
      const statusDiv = document.getElementById('status');
      statusDiv.textContent = message || (connected ? 'Connected' : 'Disconnected');
      statusDiv.className = 'status ' + (connected ? 'connected' : 'disconnected');

      document.getElementById('connectBtn').disabled = connected;
      document.getElementById('disconnectBtn').disabled = !connected;
      document.getElementById('joinRoomBtn').disabled = !connected;
    }

    function addEvent(eventType, data) {
      eventCount++;
      const eventsDiv = document.getElementById('events');

      // Remove "no events" message
      if (eventCount === 1) {
        eventsDiv.innerHTML = '';
      }

      const eventDiv = document.createElement('div');
      eventDiv.className = 'event ' + getEventClass(eventType);

      const time = new Date().toLocaleTimeString();

      eventDiv.innerHTML = `
        <div class="event-time">${time}</div>
        <div class="event-type">${eventType}</div>
        <div class="event-data">${JSON.stringify(data, null, 2)}</div>
      `;

      eventsDiv.insertBefore(eventDiv, eventsDiv.firstChild);
    }

    function getEventClass(eventType) {
      if (eventType.includes('created')) return 'task-created';
      if (eventType.includes('updated')) return 'task-updated';
      if (eventType.includes('deleted')) return 'task-deleted';
      if (eventType.includes('comment')) return 'task-comment';
      return '';
    }

    function clearEvents() {
      document.getElementById('events').innerHTML = '<p style="color: #6c757d;">Events cleared.</p>';
      eventCount = 0;
    }

    function connect() {
      const userId = document.getElementById('userId').value.trim();
      const userType = document.getElementById('userType').value;

      if (!userId) {
        alert('Please enter a user ID');
        return;
      }

      updateStatus(false, 'Connecting...');

      // Create socket connection
      socket = io('http://localhost:5000', {
        transports: ['websocket', 'polling'],
        withCredentials: true
      });

      // Connection successful
      socket.on('connect', () => {
        console.log('âœ… Connected to Socket.IO server');
        updateStatus(true, `Connected as ${userType} (${userId})`);

        // Auto-join user-specific room
        const room = `${userType}:${userId}`;
        socket.emit('join', { room });
        document.getElementById('roomName').value = room;

        addEvent('connection', {
          message: 'Connected to server',
          socketId: socket.id,
          autoJoinedRoom: room
        });
      });

      // Connection error
      socket.on('connect_error', (error) => {
        console.error('âŒ Connection error:', error);
        updateStatus(false, 'Connection failed');
        addEvent('error', { message: 'Connection error', error: error.message });
      });

      // Disconnection
      socket.on('disconnect', (reason) => {
        console.log('âŒ Disconnected:', reason);
        updateStatus(false, 'Disconnected: ' + reason);
        addEvent('disconnection', { reason });
      });

      // Listen for task events
      socket.on('task:created', (data) => {
        console.log('ðŸ“ Task created:', data);
        addEvent('task:created', data);
        showNotification('New task assigned!', data.title);
      });

      socket.on('task:updated', (data) => {
        console.log('âœï¸ Task updated:', data);
        addEvent('task:updated', data);
        showNotification('Task updated', data.title);
      });

      socket.on('task:comment_added', (data) => {
        console.log('ðŸ’¬ Comment added:', data);
        addEvent('task:comment_added', data);
        showNotification('New comment', data.message.substring(0, 50));
      });

      socket.on('task:deleted', (data) => {
        console.log('ðŸ—‘ï¸ Task deleted:', data);
        addEvent('task:deleted', data);
        showNotification('Task deleted', data.title);
      });

      socket.on('task:status_updated', (data) => {
        console.log('ðŸ”„ Status updated:', data);
        addEvent('task:status_updated', data);
        showNotification('Status updated', `${data.oldStatus} â†’ ${data.newStatus}`);
      });

      // Room joined confirmation
      socket.on('joined', (data) => {
        console.log('ðŸšª Joined room:', data);
        addEvent('joined_room', data);
      });
    }

    function disconnect() {
      if (socket) {
        socket.disconnect();
        socket = null;
        updateStatus(false, 'Disconnected');
      }
    }

    function joinRoom() {
      const roomName = document.getElementById('roomName').value.trim();

      if (!roomName) {
        alert('Please enter a room name');
        return;
      }

      if (!socket || !socket.connected) {
        alert('Please connect first');
        return;
      }

      socket.emit('join', { room: roomName });
      addEvent('join_room_request', { room: roomName });
      console.log('ðŸšª Joining room:', roomName);
    }

    function showNotification(title, body) {
      // Check if browser supports notifications
      if ('Notification' in window && Notification.permission === 'granted') {
        new Notification(title, { body });
      }
    }

    // Request notification permission on page load
    if ('Notification' in window && Notification.permission === 'default') {
      Notification.requestPermission();
    }

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
      if (socket) {
        socket.disconnect();
      }
    });
  </script>
</body>
</html>
